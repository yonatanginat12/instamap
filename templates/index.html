<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Discover</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #f5f5f7;
      --surface: #ffffff;
      --border: #e2e2e7;
      --accent: #6441a5;
      --accent-light: #ede9f8;
      --text: #1d1d1f;
      --muted: #6e6e73;
      --radius: 14px;
      --shadow: 0 2px 12px rgba(0,0,0,.08);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
    header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 2rem 1.5rem 1.25rem;
      text-align: center;
    }
    header h1 { font-size: 2rem; font-weight: 700; letter-spacing: -.5px; }
    header p  { color: var(--muted); margin-top: .3rem; font-size: .95rem; }

    #searchForm {
      display: flex; flex-wrap: wrap; gap: .75rem;
      justify-content: center; margin-top: 1.25rem;
    }
    #location {
      flex: 1 1 280px; max-width: 420px;
      padding: .65rem 1rem; border: 1.5px solid var(--border);
      border-radius: 10px; font-size: 1rem; outline: none;
      transition: border-color .2s;
    }
    #location:focus { border-color: var(--accent); }
    #searchBtn {
      padding: .65rem 1.6rem; background: var(--accent); color: #fff;
      border: none; border-radius: 10px; font-size: 1rem; font-weight: 600;
      cursor: pointer; transition: opacity .15s;
    }
    #searchBtn:hover { opacity: .88; }
    #searchBtn:disabled { opacity: .5; cursor: not-allowed; }
    #locateBtn {
      background: none; border: none; color: var(--accent);
      font-size: .85rem; font-weight: 500; cursor: pointer;
      display: flex; align-items: center; gap: .3rem;
      margin-top: .6rem; opacity: .85; transition: opacity .15s;
    }
    #locateBtn:hover { opacity: 1; text-decoration: underline; }
    #locateBtn:disabled { opacity: .4; cursor: not-allowed; text-decoration: none; }

    /* ‚îÄ‚îÄ Hashtag tooltip ‚îÄ‚îÄ */
    .ig-tip {
      position: relative; display: inline-flex; align-items: center;
      margin-left: .4rem; vertical-align: middle;
    }
    .ig-tip-icon {
      width: 17px; height: 17px; border-radius: 50%;
      background: var(--muted); color: #fff;
      font-size: .7rem; font-weight: 700;
      display: inline-flex; align-items: center; justify-content: center;
      cursor: default; user-select: none; flex-shrink: 0;
    }
    .ig-tip-box {
      display: none; position: absolute; left: 50%; top: calc(100% + 8px);
      transform: translateX(-50%);
      background: #1d1d1f; color: #f5f5f7;
      font-size: .78rem; line-height: 1.55; font-weight: 400;
      padding: .7rem .9rem; border-radius: 10px;
      width: 260px; white-space: normal;
      box-shadow: 0 4px 16px rgba(0,0,0,.25);
      z-index: 100; pointer-events: none;
    }
    .ig-tip-box::after {
      content: ''; position: absolute; bottom: 100%; left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-bottom-color: #1d1d1f;
    }
    .ig-tip:hover .ig-tip-box,
    .ig-tip:focus-within .ig-tip-box { display: block; }
    .ig-tip-box code {
      background: rgba(255,255,255,.12); border-radius: 4px;
      padding: .1em .35em; font-family: monospace; font-size: .82em;
    }

    /* ‚îÄ‚îÄ View toggle ‚îÄ‚îÄ */
    .view-toggle {
      display: flex; justify-content: center; gap: .5rem; margin-top: 1rem;
    }
    .vbtn {
      padding: .4rem 1.1rem; border: 1.5px solid var(--border);
      border-radius: 8px; font-size: .85rem; font-weight: 600;
      cursor: pointer; background: var(--surface); color: var(--muted);
      transition: all .15s;
    }
    .vbtn.active { background: var(--accent); color: #fff; border-color: var(--accent); }

    /* ‚îÄ‚îÄ Main ‚îÄ‚îÄ */
    main { max-width: 1300px; margin: 2rem auto; padding: 0 1.25rem 4rem; }

    /* ‚îÄ‚îÄ Three-column grid ‚îÄ‚îÄ */
    .results-grid {
      display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1.5rem;
    }
    @media (max-width: 1000px) { .results-grid { grid-template-columns: 1fr 1fr; } }
    @media (max-width: 600px)  { .results-grid { grid-template-columns: 1fr; } }

    /* ‚îÄ‚îÄ Map ‚îÄ‚îÄ */
    #mapView { display: none; }
    #mapContainer {
      display: flex; height: 600px;
      border-radius: var(--radius); overflow: hidden;
      box-shadow: var(--shadow);
    }
    #mapSidebar {
      width: 280px; min-width: 220px; flex-shrink: 0;
      overflow-y: auto; background: var(--surface);
      border-right: 1px solid var(--border);
    }
    #mapSidebar::-webkit-scrollbar { width: 5px; }
    #mapSidebar::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    .sidebar-item {
      display: flex; align-items: flex-start; gap: .6rem;
      padding: .75rem 1rem; cursor: pointer;
      border-bottom: 1px solid var(--border);
      transition: background .12s;
    }
    .sidebar-item:hover   { background: var(--accent-light); }
    .sidebar-item.active  { background: var(--accent-light); border-left: 3px solid var(--accent); }
    .sidebar-icon { font-size: 1.2rem; flex-shrink: 0; margin-top: .1rem; }
    .sidebar-name { font-size: .85rem; font-weight: 600; color: var(--text); line-height: 1.3; }
    .sidebar-meta { font-size: .73rem; color: var(--muted); margin-top: .15rem; line-height: 1.3; }
    #map {
      flex: 1; height: 100%; border-radius: 0;
    }
    /* legend */
    #mapLegend {
      display: flex; flex-wrap: wrap; gap: .6rem;
      margin-top: .85rem; font-size: .82rem; font-weight: 500;
    }
    .legend-item {
      display: flex; align-items: center; gap: .35rem;
      background: var(--surface); padding: .3rem .7rem;
      border-radius: 20px; box-shadow: var(--shadow);
    }
    @media (max-width: 640px) {
      #mapContainer { flex-direction: column; height: auto; }
      #mapSidebar { width: 100%; height: 200px; border-right: none; border-bottom: 1px solid var(--border); }
      #map { height: 420px; }
    }

    /* ‚îÄ‚îÄ Section header ‚îÄ‚îÄ */
    .section-header {
      display: flex; align-items: center; gap: .6rem;
      margin-bottom: 1.25rem; padding-bottom: .75rem;
      border-bottom: 2px solid var(--accent-light);
    }
    .section-header h2 { font-size: 1.2rem; font-weight: 700; }

    /* ‚îÄ‚îÄ Source block ‚îÄ‚îÄ */
    .source-block { margin-bottom: 1.75rem; }
    .source-label {
      display: flex; align-items: center; gap: .5rem;
      font-size: .8rem; font-weight: 700; text-transform: uppercase;
      letter-spacing: .06em; color: var(--muted); margin-bottom: .6rem;
    }
    .source-pill {
      font-size: .7rem; font-weight: 600; padding: .15rem .5rem; border-radius: 20px;
    }
    .pill-ig   { background: #fce8f3; color: #c2185b; }
    .pill-yelp { background: #fff0f0; color: #c0392b; }
    .pill-osm  { background: #edfdf4; color: #15803d; }

    /* ‚îÄ‚îÄ Cards ‚îÄ‚îÄ */
    .cards { display: grid; gap: .75rem; grid-template-columns: repeat(2,1fr); }
    @media (max-width: 500px) { .cards { grid-template-columns: 1fr; } }

    .card {
      background: var(--surface); border-radius: 12px;
      box-shadow: var(--shadow); overflow: hidden;
      transition: transform .15s, box-shadow .15s;
    }
    .card:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,.11); }

    /* Instagram card */
    .ig-img {
      width: 100%; aspect-ratio: 1; object-fit: cover;
      display: block; background: var(--border);
    }
    .ig-placeholder {
      width: 100%; aspect-ratio: 1;
      background: linear-gradient(135deg,#f3e9ff,#e9f0ff);
      display: flex; align-items: center; justify-content: center; font-size: 2rem;
    }
    .ig-body { padding: .6rem .75rem; }
    .ig-user { font-size: .78rem; font-weight: 600; color: var(--accent); margin-bottom: .25rem; }
    .ig-caption {
      font-size: .78rem; color: var(--muted); line-height: 1.4;
      overflow: hidden; display: -webkit-box;
      -webkit-line-clamp: 2; -webkit-box-orient: vertical;
    }
    .ig-footer {
      display: flex; align-items: center; justify-content: space-between;
      padding: .4rem .75rem; border-top: 1px solid var(--border);
      font-size: .73rem; color: var(--muted);
    }

    /* Place card */
    .place-card { padding: .85rem 1rem; }
    .place-name { font-weight: 700; font-size: .9rem; margin-bottom: .25rem; }
    .place-cats { font-size: .75rem; color: var(--accent); font-weight: 500; margin-bottom: .35rem; }
    .stars { color: #f59e0b; }
    .rating-row {
      display: flex; align-items: center; gap: .35rem;
      font-size: .78rem; color: var(--muted); margin-bottom: .3rem;
    }
    .price { color: #16a34a; font-weight: 600; }
    .place-addr { font-size: .75rem; color: var(--muted); margin-top: .3rem; line-height: 1.35; }
    .place-link {
      display: inline-block; margin-top: .5rem;
      font-size: .75rem; font-weight: 600; color: var(--accent); text-decoration: none;
    }
    .place-link:hover { text-decoration: underline; }

    /* ‚îÄ‚îÄ Show more ‚îÄ‚îÄ */
    .show-more-wrap { margin-top: .6rem; }
    .show-more-btn {
      background: none; border: 1.5px solid var(--border); border-radius: 8px;
      padding: .45rem 1rem; font-size: .82rem; font-weight: 600; color: var(--accent);
      cursor: pointer; width: 100%; transition: background .15s;
    }
    .show-more-btn:hover { background: var(--accent-light); }
    .hidden-card { display: none; }
    .hidden-card.visible { display: block; }

    /* ‚îÄ‚îÄ Map icon markers ‚îÄ‚îÄ */
    .map-icon {
      width: 32px; height: 32px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 15px; border: 2px solid #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,.35);
    }

    /* ‚îÄ‚îÄ Map popup ‚îÄ‚îÄ */
    .map-popup img { width: 120px; height: 120px; object-fit: cover; border-radius: 6px; display: block; margin-bottom: .4rem; }
    .map-popup-name { font-weight: 700; font-size: .9rem; margin-bottom: .2rem; }
    .map-popup-sub { font-size: .78rem; color: #555; margin-bottom: .3rem; }
    .map-popup a { font-size: .78rem; color: var(--accent); font-weight: 600; text-decoration: none; }

    /* ‚îÄ‚îÄ Warnings / states ‚îÄ‚îÄ */
    #warnings {
      background: #fffbeb; border: 1px solid #fde68a;
      border-radius: 10px; padding: .7rem 1rem;
      font-size: .82rem; color: #92400e; margin-bottom: 1.25rem;
    }
    #warnings ul { padding-left: 1.2rem; }
    #loading { text-align: center; padding: 4rem 1rem; color: var(--muted); }
    .spinner {
      width: 38px; height: 38px; border: 3px solid var(--border);
      border-top-color: var(--accent); border-radius: 50%;
      animation: spin .7s linear infinite; margin: 0 auto 1rem;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    #error {
      background: #fff0f0; border: 1px solid #fca5a5;
      border-radius: 10px; padding: 1rem 1.25rem; color: #b91c1c; margin-top: 1.5rem;
    }
    .empty { text-align: center; padding: 1.5rem .5rem; color: var(--muted); font-size: .85rem; }
    [hidden] { display: none !important; }

    /* ‚îÄ‚îÄ Personalize (followees) input ‚îÄ‚îÄ */
    .personalize-row {
      display: flex; align-items: center; gap: .45rem;
      justify-content: center; margin-top: .55rem;
    }
    .personalize-row label {
      font-size: .82rem; color: var(--muted); white-space: nowrap;
    }
    #ig-username {
      padding: .32rem .7rem; border: 1.5px solid var(--border);
      border-radius: 8px; font-size: .82rem; outline: none;
      width: 200px; transition: border-color .2s; background: var(--surface);
    }
    #ig-username:focus { border-color: var(--accent); }
    #ig-username::placeholder { color: #aaa; }

    /* ‚îÄ‚îÄ Followees full-width section ‚îÄ‚îÄ */
    #col-followees {
      margin-bottom: 1.5rem;
      padding-bottom: 1.25rem;
      border-bottom: 2px solid var(--accent-light);
    }
    .pill-followee { background: #e8f5e9; color: #2e7d32; }

    /* ‚îÄ‚îÄ Per-card followee badge ‚îÄ‚îÄ */
    .ig-followee-badge {
      display: inline-flex; align-items: center; gap: .2rem;
      font-size: .68rem; font-weight: 700;
      background: #e8f5e9; color: #2e7d32;
      padding: .1rem .4rem; border-radius: 20px;
      white-space: nowrap;
    }

    /* ‚îÄ‚îÄ Mobile category tabs (hidden on desktop) ‚îÄ‚îÄ */
    .mob-tabs {
      display: none;
      overflow-x: auto; -webkit-overflow-scrolling: touch;
      gap: .5rem; padding: .75rem 1rem;
      background: var(--surface); border-bottom: 1px solid var(--border);
      scrollbar-width: none;
    }
    .mob-tabs::-webkit-scrollbar { display: none; }
    .mob-tab {
      flex-shrink: 0; padding: .45rem 1.1rem;
      border: 1.5px solid var(--border); border-radius: 20px;
      font-size: .88rem; font-weight: 600; cursor: pointer;
      background: var(--surface); color: var(--muted);
      transition: all .15s; white-space: nowrap;
    }
    .mob-tab.active { background: var(--accent); color: #fff; border-color: var(--accent); }

    /* ‚îÄ‚îÄ Mobile breakpoint ‚îÄ‚îÄ */
    @media (max-width: 600px) {
      /* Sticky compact header */
      header {
        position: sticky; top: 0; z-index: 200;
        padding: .75rem 1rem .65rem;
        box-shadow: 0 2px 8px rgba(0,0,0,.07);
      }
      header h1 { font-size: 1.4rem; }
      header p  { display: none; }
      #searchForm { margin-top: .6rem; gap: .5rem; flex-wrap: nowrap; }
      /* 16px prevents iOS auto-zoom on focus */
      #location { font-size: 16px; min-width: 0; flex: 1 1 0; }
      #searchBtn { padding: .65rem 1rem; font-size: .92rem; white-space: nowrap; }
      #locateBtn { margin-top: .5rem; font-size: .82rem; }
      /* 16px prevents iOS auto-zoom on the personalize input too */
      #ig-username { font-size: 16px; width: 160px; }
      .personalize-row label { font-size: .78rem; }

      /* Tooltip: anchor to left edge on mobile so it doesn't overflow */
      .ig-tip-box { left: 0; right: auto; transform: none; }
      .ig-tip-box::after { left: 10px; transform: none; }

      /* View toggle: equal-width full-row buttons */
      .view-toggle { gap: .4rem; margin-top: .6rem; }
      .vbtn { flex: 1; padding: .55rem .5rem; font-size: .82rem; }

      /* Show mobile tabs, hide desktop 3-col grid */
      .mob-tabs { display: flex; }
      .results-grid { display: block; }
      #col-eat, #col-do, #col-sleep { display: none; }
      #col-eat.mob-active, #col-do.mob-active, #col-sleep.mob-active { display: block; }
      /* Followees section on mobile: shown/hidden via mob-active */
      #col-followees { border-bottom: none; padding-bottom: 0; margin-bottom: 0; display: none; }
      #col-followees.mob-active { display: block; }

      /* Wider cards on single-column layout */
      .cards { grid-template-columns: 1fr 1fr; }

      /* Main padding */
      main { margin: 0; padding: .75rem .75rem 5rem; }

      /* Map: sidebar becomes horizontal scrollable strip */
      #mapContainer { flex-direction: column-reverse; height: auto; border-radius: 10px; }
      #mapSidebar {
        width: 100%; height: auto;
        display: flex; flex-direction: row;
        overflow-x: auto; overflow-y: hidden;
        -webkit-overflow-scrolling: touch;
        border-right: none; border-top: 1px solid var(--border);
        scrollbar-width: none;
      }
      #mapSidebar::-webkit-scrollbar { display: none; }
      .sidebar-item {
        min-width: 160px; max-width: 200px;
        border-bottom: none; border-right: 1px solid var(--border);
        flex-shrink: 0;
      }
      #map { height: 55vw; min-height: 280px; max-height: 420px; }
    }

    @media (max-width: 380px) {
      .cards { grid-template-columns: 1fr; }
      header h1 { font-size: 1.2rem; }
    }
  </style>
</head>
<body>

<header>
  <h1>Discover</h1>
  <p>Explore Instagram posts &amp; places for any location</p>
  <form id="searchForm">
    <input id="location" type="text" placeholder="e.g. Tel Aviv, Paris, New York‚Ä¶" autocomplete="off" required />
    <span class="ig-tip" tabindex="0">
      <span class="ig-tip-icon">?</span>
      <div class="ig-tip-box">
        <strong>Instagram hashtags searched:</strong><br>
        üçΩÔ∏è Eat ‚Äî <code>#{city}food</code>, <code>#{city}foodie</code>, <code>#{city}eats</code>, <code>#{city}cafe</code><br>
        üé≠ Do &nbsp;‚Äî <code>#{city}</code>, <code>#visit{city}</code>, <code>#thingstodoin{city}</code>, <code>#{city}life</code><br>
        üõèÔ∏è Sleep ‚Äî <code>#{city}hotel</code>, <code>#{city}hotels</code>, <code>#{city}airbnb</code>, <code>#{city}stay</code><br><br>
        <em>Spaces and special characters are removed from the city name.</em>
      </div>
    </span>
    <button id="searchBtn" type="submit">Search</button>
  </form>
  <button id="locateBtn" type="button">üìç Use my current location</button>
  <div class="personalize-row">
    <label for="ig-username">üë•</label>
    <input id="ig-username" type="text" placeholder="Your Instagram username (optional)" autocomplete="username" />
  </div>
  <div class="view-toggle" id="viewToggle" hidden>
    <button class="vbtn active" id="btnGrid" onclick="setView('grid')">‚äû Grid</button>
    <button class="vbtn"        id="btnMap"  onclick="setView('map')">üó∫ Map</button>
  </div>
</header>

<main>
  <div id="loading" hidden>
    <div class="spinner"></div>
    <p>Searching Instagram and places‚Ä¶</p>
  </div>
  <div id="error" hidden></div>

  <div id="results" hidden>
    <div id="warnings" hidden></div>

    <!-- ‚îÄ‚îÄ Grid view ‚îÄ‚îÄ -->
    <div id="gridView">
      <!-- Mobile-only category tabs -->
      <div class="mob-tabs" id="mobTabs">
        <button class="mob-tab active" data-tab="eat"      onclick="selectMobTab('eat')">üçΩÔ∏è Eat</button>
        <button class="mob-tab"       data-tab="do"       onclick="selectMobTab('do')">üé≠ Do</button>
        <button class="mob-tab"       data-tab="sleep"    onclick="selectMobTab('sleep')">üõèÔ∏è Sleep</button>
        <button class="mob-tab"       data-tab="followee" onclick="selectMobTab('followee')" id="mobFolloweeTab" hidden>üë• You</button>
      </div>
      <!-- Followees section ‚Äî only shown when ig_username is set and results arrive -->
      <div id="col-followees" hidden>
        <div class="section-header">
          <span style="font-size:1.4rem">üë•</span><h2>From people you follow</h2>
        </div>
        <div class="source-block">
          <div class="source-label"><span class="source-pill pill-followee">Instagram ¬∑ Your followees</span></div>
          <div class="cards" id="followee-cards"></div>
          <div class="show-more-wrap" id="followee-more" hidden>
            <button class="show-more-btn" onclick="showMore('followee')">Show more</button>
          </div>
        </div>
      </div>

      <div class="results-grid">

        <div id="col-eat">
          <div class="section-header">
            <span style="font-size:1.4rem">üçΩÔ∏è</span><h2>Eat</h2>
          </div>
          <div class="source-block">
            <div class="source-label"><span class="source-pill pill-ig">Instagram</span></div>
            <div class="cards" id="ig-eat-cards"></div>
            <div class="show-more-wrap" id="ig-eat-more" hidden>
              <button class="show-more-btn" onclick="showMore('ig-eat')">Show more</button>
            </div>
          </div>
          <div class="source-block">
            <div class="source-label"><span class="source-pill pill-osm">OpenStreetMap</span></div>
            <div class="cards" id="osm-eat-cards"></div>
            <div class="show-more-wrap" id="osm-eat-more" hidden>
              <button class="show-more-btn" onclick="showMore('osm-eat')">Show more</button>
            </div>
          </div>
        </div>

        <div id="col-do">
          <div class="section-header">
            <span style="font-size:1.4rem">üé≠</span><h2>Do</h2>
          </div>
          <div class="source-block">
            <div class="source-label"><span class="source-pill pill-ig">Instagram</span></div>
            <div class="cards" id="ig-do-cards"></div>
            <div class="show-more-wrap" id="ig-do-more" hidden>
              <button class="show-more-btn" onclick="showMore('ig-do')">Show more</button>
            </div>
          </div>
          <div class="source-block">
            <div class="source-label"><span class="source-pill pill-osm">OpenStreetMap</span></div>
            <div class="cards" id="osm-do-cards"></div>
            <div class="show-more-wrap" id="osm-do-more" hidden>
              <button class="show-more-btn" onclick="showMore('osm-do')">Show more</button>
            </div>
          </div>
        </div>

        <div id="col-sleep">
          <div class="section-header">
            <span style="font-size:1.4rem">üõèÔ∏è</span><h2>Sleep</h2>
          </div>
          <div class="source-block">
            <div class="source-label"><span class="source-pill pill-ig">Instagram</span></div>
            <div class="cards" id="ig-sleep-cards"></div>
            <div class="show-more-wrap" id="ig-sleep-more" hidden>
              <button class="show-more-btn" onclick="showMore('ig-sleep')">Show more</button>
            </div>
          </div>
          <div class="source-block">
            <div class="source-label"><span class="source-pill pill-osm">OpenStreetMap</span></div>
            <div class="cards" id="osm-sleep-cards"></div>
            <div class="show-more-wrap" id="osm-sleep-more" hidden>
              <button class="show-more-btn" onclick="showMore('osm-sleep')">Show more</button>
            </div>
          </div>
        </div>

      </div>
    </div><!-- #gridView -->

    <!-- ‚îÄ‚îÄ Map view ‚îÄ‚îÄ -->
    <div id="mapView">
      <div id="mapContainer">
        <div id="mapSidebar"><div id="sidebarList"></div></div>
        <div id="map"></div>
      </div>
      <div id="mapLegend">
        <div class="legend-item"><span>üçΩÔ∏è</span> Eat</div>
        <div class="legend-item"><span>üé≠</span> Do</div>
        <div class="legend-item"><span>üõèÔ∏è</span> Sleep</div>
        <div class="legend-item"><span>üì∑</span> Instagram</div>
        <div class="legend-item" id="legendFollowee" hidden><span>üë•</span> Your followees</div>
      </div>
      <div id="mapNoCoords" style="margin-top:2rem" hidden></div>
    </div>

  </div><!-- #results -->
</main>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  const PREVIEW = 4;
  let _map = null;
  let _markers = [];        // Leaflet marker objects
  let _markerItems = [];    // { marker, el } for sidebar‚Üîmap linking
  let _activeIdx = -1;
  let _lastData = null;

  /* ‚îÄ‚îÄ Utilities ‚îÄ‚îÄ */
  function esc(s) {
    return String(s ?? '')
      .replace(/&/g,'&amp;').replace(/</g,'&lt;')
      .replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }
  function stars(r) {
    return '‚òÖ'.repeat(Math.floor(r)) + (r % 1 >= .5 ? '¬Ω' : '') +
           '‚òÜ'.repeat(5 - Math.floor(r) - (r % 1 >= .5 ? 1 : 0));
  }

  /* ‚îÄ‚îÄ View toggle ‚îÄ‚îÄ */
  function setView(v) {
    document.getElementById('gridView').style.display = v === 'grid' ? 'block' : 'none';
    document.getElementById('mapView').style.display  = v === 'map'  ? 'block' : 'none';
    document.getElementById('btnGrid').classList.toggle('active', v === 'grid');
    document.getElementById('btnMap').classList.toggle('active',  v === 'map');
    if (v === 'map') {
      // Defer until after the browser has laid out the now-visible container.
      // Without this, L.map() reads a 0√ó0 size and tiles never render.
      setTimeout(() => initMap(_lastData), 50);
    }
  }

  /* ‚îÄ‚îÄ Mobile category tabs ‚îÄ‚îÄ */
  function selectMobTab(cat) {
    ['eat','do','sleep','followee'].forEach(c => {
      const col = document.getElementById(`col-${c}`);
      if (col) col.classList.toggle('mob-active', c === cat);
      const btn = document.querySelector(`#mobTabs [data-tab="${c}"]`);
      if (btn) btn.classList.toggle('active', c === cat);
    });
  }

  /* ‚îÄ‚îÄ Show more / less ‚îÄ‚îÄ */
  function showMore(key) {
    const hidden   = document.querySelectorAll(`#${key}-cards .hidden-card`);
    const btn      = document.querySelector(`#${key}-more .show-more-btn`);
    const expanded = btn.dataset.expanded === '1';
    hidden.forEach(el => el.classList.toggle('visible', !expanded));
    btn.textContent      = expanded ? 'Show more' : 'Show less';
    btn.dataset.expanded = expanded ? '0' : '1';
  }

  /* ‚îÄ‚îÄ Card renderers ‚îÄ‚îÄ */
  function renderIgCard(p, isFollowee) {
    const img = p.image_url
      ? `<img class="ig-img" src="${esc(p.image_url)}" loading="lazy"
             onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">`
      : '';
    const ph = `<div class="ig-placeholder"${p.image_url ? ' style="display:none"' : ''}>üì∑</div>`;
    return `
      <a class="card" href="${esc(p.url)}" target="_blank" rel="noopener"
         style="text-decoration:none;color:inherit">
        ${img}${ph}
        <div class="ig-body">
          <div class="ig-user">@${esc(p.username)}</div>
          ${p.caption ? `<div class="ig-caption">${esc(p.caption)}</div>` : ''}
        </div>
        <div class="ig-footer">
          <span>‚ù§Ô∏è ${p.likes.toLocaleString()}</span>
          ${isFollowee ? `<span class="ig-followee-badge">üë• Following</span>` : (p.location_name ? `<span>üìç ${esc(p.location_name)}</span>` : '')}
        </div>
      </a>`;
  }

  function renderPlaceCard(p, isYelp) {
    return `
      <div class="card place-card">
        <div class="place-name">${esc(p.name)}</div>
        ${p.categories?.length ? `<div class="place-cats">${esc(p.categories.join(' ¬∑ '))}</div>` : ''}
        ${isYelp ? `<div class="rating-row">
          <span class="stars">${stars(p.rating)}</span>
          <span>${p.rating} (${p.review_count?.toLocaleString()})</span>
          ${p.price ? `<span class="price">${esc(p.price)}</span>` : ''}
        </div>` : ''}
        ${p.address ? `<div class="place-addr">üìç ${esc(p.address)}</div>` : ''}
        ${(p.url || p.link) ? `<a class="place-link"
          href="${esc(p.url || p.link)}" target="_blank" rel="noopener">
          View on ${isYelp ? 'Yelp' : 'OpenStreetMap'} ‚Üí</a>` : ''}
      </div>`;
  }

  function fillCards(containerId, moreId, htmlItems) {
    const container = document.getElementById(containerId);
    const moreWrap  = document.getElementById(moreId);
    if (!htmlItems.length) {
      container.innerHTML = '<div class="empty">No results</div>';
      return;
    }
    container.innerHTML = htmlItems.map((html, i) =>
      `<div class="${i >= PREVIEW ? 'hidden-card' : ''}">${html}</div>`
    ).join('');
    if (htmlItems.length > PREVIEW) {
      moreWrap.hidden = false;
      const rem = htmlItems.length - PREVIEW;
      moreWrap.querySelector('button').textContent = `Show ${rem} more`;
      moreWrap.querySelector('button').dataset.expanded = '0';
    } else {
      moreWrap.hidden = true;
    }
  }

  /* ‚îÄ‚îÄ Map ‚îÄ‚îÄ */
  const _CATEGORY_STYLE = {
    eat:      { emoji: 'üçΩÔ∏è', bg: '#e53935' },
    do:       { emoji: 'üé≠', bg: '#7b1fa2' },
    sleep:    { emoji: 'üõèÔ∏è', bg: '#1565c0' },
    ig:       { emoji: 'üì∑', bg: '#37474f' },
    followee: { emoji: 'üë•', bg: '#00897b' },
  };

  function iconMarker(lat, lon, category, popupHtml) {
    const { emoji, bg } = _CATEGORY_STYLE[category] || _CATEGORY_STYLE.ig;
    const icon = L.divIcon({
      html: `<div class="map-icon" style="background:${bg}">${emoji}</div>`,
      className: '',
      iconSize: [32, 32],
      iconAnchor: [16, 16],
      popupAnchor: [0, -18],
    });
    return L.marker([lat, lon], { icon }).bindPopup(popupHtml, { maxWidth: 220 });
  }

  function igPopup(p) {
    return `<div class="map-popup">
      ${p.image_url ? `<img src="${esc(p.image_url)}" onerror="this.style.display='none'">` : ''}
      <div class="map-popup-name">@${esc(p.username)}</div>
      <div class="map-popup-sub">‚ù§Ô∏è ${p.likes.toLocaleString()}
        ${p.location_name ? ' ¬∑ üìç ' + esc(p.location_name) : ''}</div>
      ${p.caption ? `<div class="map-popup-sub" style="-webkit-line-clamp:2;display:-webkit-box;-webkit-box-orient:vertical;overflow:hidden">${esc(p.caption)}</div>` : ''}
      <a href="${esc(p.url)}" target="_blank" rel="noopener">View on Instagram ‚Üí</a>
    </div>`;
  }

  function placePopup(p, isYelp) {
    return `<div class="map-popup">
      <div class="map-popup-name">${esc(p.name)}</div>
      ${p.categories?.length ? `<div class="map-popup-sub">${esc(p.categories.join(' ¬∑ '))}</div>` : ''}
      ${isYelp ? `<div class="map-popup-sub">${stars(p.rating)} ${p.rating}
        (${p.review_count?.toLocaleString()})${p.price ? ' ¬∑ ' + esc(p.price) : ''}</div>` : ''}
      ${p.address ? `<div class="map-popup-sub">üìç ${esc(p.address)}</div>` : ''}
      ${(p.url || p.link) ? `<a href="${esc(p.url || p.link)}" target="_blank" rel="noopener">
        View on ${isYelp ? 'Yelp' : 'OpenStreetMap'} ‚Üí</a>` : ''}
    </div>`;
  }

  async function geocodeLocation(location) {
    try {
      const r = await fetch(
        `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(location)}&format=json&limit=1`,
        { headers: { 'Accept-Language': 'en' } }
      );
      const json = await r.json();
      if (json.length) return [parseFloat(json[0].lat), parseFloat(json[0].lon)];
    } catch {}
    return null;
  }

  function focusMarker(idx) {
    if (_activeIdx >= 0 && _markerItems[_activeIdx])
      _markerItems[_activeIdx].el.classList.remove('active');
    _activeIdx = idx;
    const { marker, el } = _markerItems[idx];
    el.classList.add('active');
    el.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
    const ll = marker.getLatLng();
    _map.setView(ll, Math.max(_map.getZoom(), 15), { animate: true });
    marker.openPopup();
  }

  async function initMap(data) {
    if (!data) return;

    // Remove previous markers
    _markers.forEach(m => m.remove());
    _markers = [];
    _markerItems = [];
    _activeIdx = -1;

    const allPoints   = [];
    const noCoordPosts = [];
    const sidebarRows  = [];   // { category, name, meta } for sidebar

    function addMarker(lat, lon, category, popupHtml, name, meta) {
      const m = iconMarker(lat, lon, category, popupHtml);
      const idx = _markers.length;
      _markers.push(m);
      allPoints.push([lat, lon]);
      sidebarRows.push({ category, name, meta, idx });
    }

    data.instagram_posts.forEach(p => {
      const cat = ['eat','do','sleep'].includes(p.post_category) ? p.post_category : 'ig';
      if (p.lat != null && p.lon != null) {
        const meta = [p.location_name, `‚ù§Ô∏è ${p.likes.toLocaleString()}`].filter(Boolean).join(' ¬∑ ');
        addMarker(p.lat, p.lon, cat, igPopup(p), `@${p.username}`, meta);
      } else noCoordPosts.push({ type: 'ig', item: p });
    });
    (data.followee_posts || []).forEach(p => {
      if (p.lat != null && p.lon != null) {
        const meta = [p.location_name, `‚ù§Ô∏è ${p.likes.toLocaleString()}`].filter(Boolean).join(' ¬∑ ');
        addMarker(p.lat, p.lon, 'followee', igPopup(p), `@${p.username}`, meta);
      } else noCoordPosts.push({ type: 'ig', item: p });
    });
    data.osm_eat.forEach(p => {
      if (p.lat != null && p.lon != null)
        addMarker(p.lat, p.lon, 'eat', placePopup(p, false), p.name, p.address || p.categories.join(' ¬∑ '));
      else noCoordPosts.push({ type: 'osm', item: p });
    });
    data.osm_do.forEach(p => {
      if (p.lat != null && p.lon != null)
        addMarker(p.lat, p.lon, 'do', placePopup(p, false), p.name, p.address || p.categories.join(' ¬∑ '));
      else noCoordPosts.push({ type: 'osm', item: p });
    });
    data.osm_sleep.forEach(p => {
      if (p.lat != null && p.lon != null)
        addMarker(p.lat, p.lon, 'sleep', placePopup(p, false), p.name, p.address || p.categories.join(' ¬∑ '));
      else noCoordPosts.push({ type: 'osm', item: p });
    });

    // Init map only once ‚Äî container must be visible before this runs
    if (!_map) {
      _map = L.map('map', { preferCanvas: true });
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© <a href="https://openstreetmap.org">OpenStreetMap</a> contributors',
        maxZoom: 19,
      }).addTo(_map);
    }

    // MUST call invalidateSize() before fitBounds/setView ‚Äî Leaflet reads
    // the container size when calculating bounds, and the container may have
    // been hidden (display:none) before this call, causing a stale 0√ó0 size.
    // Calling invalidateSize() after fitBounds triggers an internal resize
    // event that resets the view, producing the "world map" bug.
    _map.invalidateSize();

    // Build sidebar
    const sidebarList = document.getElementById('sidebarList');
    const { emoji: _e } = {}; // unused ‚Äî access via _CATEGORY_STYLE
    sidebarList.innerHTML = sidebarRows.length
      ? sidebarRows.map(({ category, name, meta, idx }) => {
          const { emoji } = _CATEGORY_STYLE[category] || { emoji: 'üìç' };
          return `<div class="sidebar-item" onclick="focusMarker(${idx})" data-idx="${idx}">
            <div class="sidebar-icon">${emoji}</div>
            <div>
              <div class="sidebar-name">${esc(name)}</div>
              ${meta ? `<div class="sidebar-meta">${esc(meta)}</div>` : ''}
            </div>
          </div>`;
        }).join('')
      : '<div style="padding:1rem;color:var(--muted);font-size:.85rem">No items to show</div>';

    // Link sidebar DOM elements to markers for two-way highlight
    sidebarRows.forEach(({ idx }) => {
      const el = sidebarList.querySelector(`[data-idx="${idx}"]`);
      _markerItems[idx] = { marker: _markers[idx], el };
      _markers[idx].on('click', () => {
        if (_activeIdx >= 0 && _markerItems[_activeIdx])
          _markerItems[_activeIdx].el.classList.remove('active');
        _activeIdx = idx;
        el.classList.add('active');
        el.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
      });
    });

    _markers.forEach(m => m.addTo(_map));

    if (allPoints.length) {
      _map.fitBounds(L.latLngBounds(allPoints), { padding: [40, 40], maxZoom: 16 });
    } else {
      // Use location coords from the API response (already geocoded server-side)
      const center = data.location_lat != null
        ? [data.location_lat, data.location_lon]
        : null;
      if (center) {
        _map.setView(center, 13);
      } else {
        // Last resort: geocode in browser
        const coords = await geocodeLocation(data.location);
        _map.setView(coords ?? [0, 0], coords ? 13 : 2);
      }
    }

    renderNoCoords(noCoordPosts);
  }

  function renderNoCoords(items) {
    const el = document.getElementById('mapNoCoords');
    if (!items.length) { el.hidden = true; return; }
    el.hidden = false;
    el.innerHTML = `
      <div style="font-size:.85rem;font-weight:700;color:var(--muted);
                  text-transform:uppercase;letter-spacing:.06em;margin-bottom:.75rem">
        üìç No location data (${items.length})
      </div>
      <div class="cards" style="grid-template-columns:repeat(auto-fill,minmax(200px,1fr))">
        ${items.map(({ type, item }) =>
          type === 'ig'
            ? renderIgCard(item)
            : renderPlaceCard(item, type === 'yelp')
        ).join('')}
      </div>`;
  }

  /* ‚îÄ‚îÄ Render places (OSM) ‚Äî called immediately on phase 1 ‚îÄ‚îÄ */
  function renderPlaces(data) {
    fillCards('osm-eat-cards',   'osm-eat-more',   data.osm_eat.map(p   => renderPlaceCard(p, false)));
    fillCards('osm-do-cards',    'osm-do-more',    data.osm_do.map(p    => renderPlaceCard(p, false)));
    fillCards('osm-sleep-cards', 'osm-sleep-more', data.osm_sleep.map(p => renderPlaceCard(p, false)));
    // Activate first tab on mobile
    selectMobTab('eat');

    const warnEl = document.getElementById('warnings');
    if (data.warnings?.length) {
      warnEl.innerHTML = `<ul>${data.warnings.map(w => `<li>${esc(w)}</li>`).join('')}</ul>`;
      warnEl.hidden = false;
    } else {
      warnEl.hidden = true;
    }
  }

  /* ‚îÄ‚îÄ Current location ‚îÄ‚îÄ */
  document.getElementById('locateBtn').addEventListener('click', () => {
    if (!navigator.geolocation) {
      alert('Geolocation is not supported by your browser.');
      return;
    }
    const btn = document.getElementById('locateBtn');
    btn.disabled = true;
    btn.textContent = '‚è≥';

    navigator.geolocation.getCurrentPosition(
      async ({ coords: { latitude: lat, longitude: lon } }) => {
        try {
          const r = await fetch(
            `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`,
            { headers: { 'Accept-Language': 'en' } }
          );
          const data = await r.json();
          const addr = data.address || {};
          const city = addr.city || addr.town || addr.village ||
                       addr.county || addr.state || data.display_name;
          document.getElementById('location').value = city;
        } catch {
          // Fall back to raw coordinates if reverse geocode fails
          document.getElementById('location').value = `${lat.toFixed(5)},${lon.toFixed(5)}`;
        }
        btn.disabled = false;
        btn.textContent = 'üìç';
        document.getElementById('searchForm').dispatchEvent(new Event('submit'));
      },
      (err) => {
        btn.disabled = false;
        btn.textContent = 'üìç';
        alert('Could not get your location: ' + err.message);
      },
      { timeout: 10000 }
    );
  });

  /* ‚îÄ‚îÄ Instagram loading placeholder ‚îÄ‚îÄ */
  function showIgLoading() {
    const placeholder = `<div class="empty" style="padding:1rem">
      <div class="spinner" style="width:22px;height:22px;border-width:2px;margin-bottom:.5rem"></div>
      Loading Instagram‚Ä¶
    </div>`;
    ['ig-eat-cards','ig-do-cards','ig-sleep-cards'].forEach(id => {
      document.getElementById(id).innerHTML = placeholder;
    });
  }

  /* ‚îÄ‚îÄ Render followee posts ‚îÄ‚îÄ */
  function renderFolloweePosts(posts) {
    const section = document.getElementById('col-followees');
    const mobTab  = document.getElementById('mobFolloweeTab');
    if (!posts.length) {
      section.hidden = true;
      mobTab.hidden  = true;
      return;
    }
    section.hidden = false;
    mobTab.hidden  = false;
    document.getElementById('legendFollowee').hidden = false;
    fillCards('followee-cards', 'followee-more', posts.map(p => renderIgCard(p, true)));
  }

  /* ‚îÄ‚îÄ Search ‚îÄ‚îÄ */
  document.getElementById('searchForm').addEventListener('submit', async e => {
    e.preventDefault();
    const location   = document.getElementById('location').value.trim();
    const igUsername = document.getElementById('ig-username').value.trim();
    if (!location) return;

    const btn = document.getElementById('searchBtn');
    btn.disabled = true; btn.textContent = 'Searching‚Ä¶';
    document.getElementById('loading').hidden  = false;
    document.getElementById('results').hidden  = true;
    document.getElementById('error').hidden    = true;
    document.getElementById('viewToggle').hidden = true;

    // Reset followees section & legend
    document.getElementById('col-followees').hidden = true;
    document.getElementById('mobFolloweeTab').hidden = true;
    document.getElementById('legendFollowee').hidden = true;

    // Reset map on new search
    if (_map) { _markers.forEach(m => m.remove()); _markers = []; }

    const qs = `location=${encodeURIComponent(location)}&category=all`;

    // Fire all requests in parallel ‚Äî places is fast, instagram & followees are slow
    const placesPromise   = fetch(`/api/search/places?${qs}`);
    const igPromise       = fetch(`/api/search/instagram?${qs}`);
    const followeePromise = igUsername
      ? fetch(`/api/search/followees?${qs}&ig_username=${encodeURIComponent(igUsername)}`)
      : Promise.resolve(null);

    try {
      // Phase 1: render places as soon as they arrive (~3-8s)
      const pr = await placesPromise;
      if (!pr.ok) throw new Error(`Server error ${pr.status}`);
      const placesData = await pr.json();

      _lastData = {
        location:        placesData.location,
        location_lat:    placesData.location_lat,
        location_lon:    placesData.location_lon,
        instagram_posts: [],
        followee_posts:  [],
        yelp_businesses: placesData.yelp_businesses,
        osm_eat:         placesData.osm_eat,
        osm_do:          placesData.osm_do,
        osm_sleep:       placesData.osm_sleep,
        warnings:        placesData.warnings,
      };
      renderPlaces(_lastData);
      showIgLoading();
      document.getElementById('loading').hidden = false;
      document.getElementById('results').hidden = false;
      document.getElementById('viewToggle').hidden = false;
      setView('grid');

      // Phase 2: fill in Instagram hashtag posts when ready
      igPromise.then(r => r.ok ? r.json() : []).then(posts => {
        _lastData.instagram_posts = posts;
        fillCards('ig-eat-cards',   'ig-eat-more',   posts.filter(p => p.post_category === 'eat').map(renderIgCard));
        fillCards('ig-do-cards',    'ig-do-more',    posts.filter(p => p.post_category === 'do').map(renderIgCard));
        fillCards('ig-sleep-cards', 'ig-sleep-more', posts.filter(p => p.post_category === 'sleep').map(renderIgCard));
        if (document.getElementById('mapView').style.display !== 'none') initMap(_lastData);
      }).catch(() => {
        ['ig-eat-cards','ig-do-cards','ig-sleep-cards'].forEach(id => {
          document.getElementById(id).innerHTML = '<div class="empty">Instagram unavailable</div>';
        });
      }).finally(() => {
        document.getElementById('loading').hidden = true;
        btn.disabled = false; btn.textContent = 'Search';
      });

      // Phase 3: fill in followee posts when ready (independent of phase 2)
      followeePromise.then(r => r ? (r.ok ? r.json() : []) : []).then(posts => {
        _lastData.followee_posts = posts;
        renderFolloweePosts(posts);
        if (document.getElementById('mapView').style.display !== 'none') initMap(_lastData);
      }).catch(() => {});

    } catch (err) {
      const el = document.getElementById('error');
      el.textContent = `Error: ${err.message}`;
      el.hidden = false;
      document.getElementById('loading').hidden = true;
      btn.disabled = false; btn.textContent = 'Search';
    }
  });
</script>
</body>
</html>
